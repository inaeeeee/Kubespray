name: Deploy lb-web on External K8s Server (Local with SSH)

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •

jobs:
  deploy:
    runs-on: self-hosted  # GitHub Actions ì‹¤í–‰ ì„œë²„

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch lb-web Deployment Info from PostgreSQL via HAProxy
        run: |
          echo "ğŸ” Fetching lb-web deployment information from PostgreSQL via HAProxy..."

          # PostgreSQL ì •ë³´ ì¡°íšŒ (HAProxy ê²½ìœ í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ì˜ Primaryì—ì„œ ê°€ì ¸ì˜´)
          SERVICE_INFO=$(psql -h 192.168.60.67 -p 5000 -U postgres -d solmakasedb -t -c \
            "SELECT name, deploy_script FROM servicetemplate WHERE name = 'lb-web';")

          # ë°ì´í„°ê°€ ë¹„ì–´ìˆë‹¤ë©´ ì˜¤ë¥˜ ì²˜ë¦¬
          if [[ -z "$SERVICE_INFO" ]]; then
            echo "âŒ No deployment information found for lb-web!"
            exit 1
          fi

          echo "âœ… Found lb-web service info:"
          echo "$SERVICE_INFO"

          # ë°ì´í„° íŒŒì‹± (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ ì¶”ì¶œ)
          SERVICE_NAME=$(echo "$SERVICE_INFO" | awk -F '|' '{print $1}' | xargs)
          DEPLOY_SCRIPT=$(echo "$SERVICE_INFO" | awk -F '|' '{print $2}' | xargs)

          echo "----------------------------------------"
          echo "ğŸ“Œ Service: $SERVICE_NAME"
          echo "ğŸ“Œ Deploy Script Path: $DEPLOY_SCRIPT"

          # YAML íŒŒì¼ ê²½ë¡œ ì •ì˜
          YAML_FILE="/var/lib/pgsql/data/service_templates/lb_web/yaml/deployment.yaml"

          echo "ğŸš€ Copying deployment script and YAML to Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no root@192.168.30.32 "mkdir -p /tmp/lb-web"
          scp -o StrictHostKeyChecking=no "$DEPLOY_SCRIPT" root@192.168.30.32:/tmp/lb-web/deploy.sh
          scp -o StrictHostKeyChecking=no "$YAML_FILE" root@192.168.30.32:/tmp/lb-web/deployment.yaml

      - name: Execute Deploy Script on Kubernetes Master Server
        run: |
          echo "ğŸš€ Executing deployment script on Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no root@192.168.30.32 "chmod +x /tmp/lb-web/deploy.sh && /tmp/lb-web/deploy.sh"
