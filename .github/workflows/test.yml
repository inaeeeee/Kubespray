name: Deploy lb-web on External K8s Server (Local with SSH)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Install PostgreSQL Client on CentOS
        run: |
          echo "üîß Checking if PostgreSQL Client (psql) is installed..."
          if ! command -v psql &> /dev/null
          then
            echo "‚ö†Ô∏è PostgreSQL Client not found. Installing..."
            sudo yum install -y postgresql
          else
            echo "‚úÖ PostgreSQL Client is already installed."
          fi

      - name: Configure PostgreSQL Authentication
        run: |
          echo "üîë Setting up .pgpass for PostgreSQL authentication..."
          echo "192.168.60.67:5000:solmakasedb:postgres:your_postgres_password" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch lb-web Deployment Info from PostgreSQL via HAProxy
        run: |
          echo "üîç Fetching lb-web deployment information from PostgreSQL via HAProxy..."

          SERVICE_INFO=$(psql -h 192.168.60.67 -p 5000 -U postgres -d solmakasedb -t -c \
            "SELECT name, deploy_script FROM servicetemplate WHERE name = 'lb-web';")

          if [[ -z "$SERVICE_INFO" ]]; then
            echo "‚ùå No deployment information found for lb-web!"
            exit 1
          fi

          echo "‚úÖ Found lb-web service info: $SERVICE_INFO"

          SERVICE_NAME=$(echo "$SERVICE_INFO" | awk -F '|' '{print $1}' | xargs)
          DEPLOY_SCRIPT=$(echo "$SERVICE_INFO" | awk -F '|' '{print $2}' | xargs)

          echo "üìå Service: $SERVICE_NAME"
          echo "üìå Deploy Script Path on DB Server: $DEPLOY_SCRIPT"

          YAML_FILE="/var/lib/pgsql/data/service_templates/lb_web/yaml/deployment.yaml"

          echo "üöÄ Fetching deployment script and YAML from DB server (192.168.60.67)..."
          mkdir -p /tmp/lb-web

          scp -o StrictHostKeyChecking=no postgres@192.168.60.67:$DEPLOY_SCRIPT /tmp/lb-web/deploy.sh
          scp -o StrictHostKeyChecking=no postgres@192.168.60.67:$YAML_FILE /tmp/lb-web/deployment.yaml

          echo "üöÄ Copying deployment script and YAML to Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "mkdir -p /tmp/lb-web"
          scp -o StrictHostKeyChecking=no /tmp/lb-web/deploy.sh devops@192.168.30.32:/tmp/lb-web/deploy.sh
          scp -o StrictHostKeyChecking=no /tmp/lb-web/deployment.yaml devops@192.168.30.32:/tmp/lb-web/deployment.yaml"

      - name: Execute Deploy Script on Kubernetes Master Server
        run: |
          echo "üöÄ Executing deployment script on Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "chmod +x /tmp/lb-web/deploy.sh && /tmp/lb-web/deploy.sh"
