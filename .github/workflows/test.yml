name: Deploy lb-web on External K8s Server (Local with SSH)

on:
  workflow_dispatch:  # Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïã§Ìñâ

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Install PostgreSQL Client on CentOS
        run: |
          echo "üîß Checking if PostgreSQL Client (psql) is installed..."
          if ! command -v psql &> /dev/null
          then
            echo "‚ö†Ô∏è PostgreSQL Client not found. Installing..."
            sudo yum install -y postgresql
          else
            echo "‚úÖ PostgreSQL Client is already installed."
          fi

      - name: Setup PostgreSQL Authentication (Avoid Password Prompts)
        run: |
          echo "üîß Configuring PostgreSQL authentication..."
          echo "192.168.60.67:5001:*:postgres:qaz123" > ~/.pgpass  # ‚úÖ Slave (SELECT)
          echo "192.168.60.67:5000:*:postgres:qaz123" >> ~/.pgpass  # ‚úÖ Master (INSERT, UPDATE)
          chmod 600 ~/.pgpass

      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch lb-web Deployment Info from PostgreSQL via HAProxy (Slave)
        run: |
          echo "üîç Fetching lb-web deployment information from PostgreSQL via HAProxy (Slave)..."

          SERVICE_INFO=$(psql -h 192.168.60.67 -p 5001 -U postgres -d solmakasedb -t -w -c \
            "SELECT name, deploy_script FROM servicetemplate WHERE name = 'lb-web';")

          if [[ -z "$SERVICE_INFO" ]]; then
            echo "‚ùå No deployment information found for lb-web!"
            exit 1
          fi

          echo "‚úÖ Found lb-web service info: $SERVICE_INFO"

          DEPLOY_SCRIPT=$(echo "$SERVICE_INFO" | awk -F '|' '{print $2}' | xargs)

          echo "üìå Deploy Script Path: $DEPLOY_SCRIPT"

      - name: Deploy VM to Kubernetes
        run: |
          echo "üöÄ Deploying VM in Kubernetes..."
          kubectl apply -f /tmp/lb-web/deployment.yaml
          sleep 5  # KubernetesÍ∞Ä PodÎ•º ÏÉùÏÑ±Ìï† ÏãúÍ∞ÑÏùÑ Ï§å
          echo "‚úÖ Kubernetes Deployment Completed"

      - name: Fetch VM Information from Kubernetes
        id: fetch_vms
        run: |
          echo "üîç Fetching VM information..."
          POD_INFO=$(kubectl get pods -o jsonpath='{range .items[*]}{.metadata.name}{"|"}{.status.podIP}{"\n"}{end}')
          echo "POD_INFO=$POD_INFO" >> $GITHUB_ENV
          echo "‚úÖ VM Information Fetched"

      - name: Store VM Information in PostgreSQL (Master)
        run: |
          echo "üóÑ Storing VM Information in PostgreSQL (Master)..."

          while IFS="|" read -r HOSTNAME IP_ADDRESS; do
              if [[ -n "$HOSTNAME" && -n "$IP_ADDRESS" ]]; then
                  STATUS="running"
                  echo "üìå Saving VM: $HOSTNAME ($IP_ADDRESS)"

                  # Master(5000)Î°ú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                  psql -h 192.168.60.67 -p 5000 -U postgres -d solmakasedb -c \
                  "INSERT INTO VM (workspace_id, hostname, ip_address, status)
                   VALUES (1, '$HOSTNAME', '$IP_ADDRESS', 'running')
                   ON CONFLICT (hostname) 
                   DO UPDATE SET ip_address = EXCLUDED.ip_address, status = 'running';"
              fi
          done <<< "$POD_INFO"

          echo "‚úÖ VM Information Stored in PostgreSQL"

      - name: Fix Permissions on Kubernetes Master Server
        run: |
          echo "üîß Ensuring correct permissions for /tmp/lb-web on Kubernetes master server..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "sudo mkdir -p /tmp/lb-web && sudo chown -R devops:devops /tmp/lb-web"

      - name: Copy Deployment Files to Kubernetes Master Server
        run: |
          echo "üöÄ Copying deployment script and YAML to Kubernetes master server (192.168.30.32)..."
          scp -o StrictHostKeyChecking=no /tmp/lb-web/deploy.sh devops@192.168.30.32:/tmp/lb-web/deploy.sh
          scp -o StrictHostKeyChecking=no /tmp/lb-web/deployment.yaml devops@192.168.30.32:/tmp/lb-web/deployment.yaml

      - name: Execute Deploy Script on Kubernetes Master Server
        run: |
          echo "üöÄ Executing deployment script on Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "chmod +x /tmp/lb-web/deploy.sh && /tmp/lb-web/deploy.sh"
