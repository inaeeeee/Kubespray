name: Deploy lb-web on External K8s Server (Local with SSH)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Install PostgreSQL Client on CentOS
        run: |
          echo "ğŸ”§ Checking if PostgreSQL Client (psql) is installed..."
          if ! command -v psql &> /dev/null
          then
            echo "âš ï¸ PostgreSQL Client not found. Installing..."
            sudo yum install -y postgresql
          else
            echo "âœ… PostgreSQL Client is already installed."
          fi

      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch lb-web Deployment Info from PostgreSQL via HAProxy (Slave)
        run: |
          echo "ğŸ” Fetching lb-web deployment information from PostgreSQL via HAProxy (Slave)..."

          # PostgreSQL ë¹„ë°€ë²ˆí˜¸ ì—†ì´ HAProxy(5001)ì—ì„œ ë°ì´í„° ì¡°íšŒ
          SERVICE_INFO=$(psql -h 192.168.60.67 -p 5001 -U postgres -d solmakasedb -t -c \
            "SELECT name, deploy_script FROM servicetemplate WHERE name = 'lb-web';")

          if [[ -z "$SERVICE_INFO" ]]; then
            echo "âŒ No deployment information found for lb-web!"
            exit 1
          fi

          echo "âœ… Found lb-web service info: $SERVICE_INFO"

          DEPLOY_SCRIPT=$(echo "$SERVICE_INFO" | awk -F '|' '{print $2}' | xargs)

          echo "ğŸ“Œ Deploy Script Path: $DEPLOY_SCRIPT"

          # ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” DB ì„œë²„ ëª©ë¡
          DB_SERVERS=("192.168.60.64" "192.168.60.65" "192.168.60.66")
          SELECTED_DB_SERVER=""

          echo "ğŸ” Finding the correct DB server where the deployment script exists..."

          # ì‹¤ì œë¡œ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” DB ì„œë²„ ì°¾ê¸°
          for DB_SERVER in "${DB_SERVERS[@]}"; do
              echo "ğŸ” Checking on $DB_SERVER..."
              if ssh -o StrictHostKeyChecking=no postgres@$DB_SERVER "test -f $DEPLOY_SCRIPT"; then
                  SELECTED_DB_SERVER=$DB_SERVER
                  echo "âœ… Deployment script found on $DB_SERVER"
                  break
              fi
          done

          # DB ì„œë²„ë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ì˜¤ë¥˜ ë°œìƒ
          if [[ -z "$SELECTED_DB_SERVER" ]]; then
              echo "âŒ ERROR: No DB server contains the deployment script!"
              exit 1
          fi

          echo "ğŸš€ Fetching deployment script from DB server ($SELECTED_DB_SERVER)..."
          mkdir -p /tmp/lb-web

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë° YAMLì„ í•´ë‹¹ DB ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no postgres@$SELECTED_DB_SERVER:$DEPLOY_SCRIPT /tmp/lb-web/deploy.sh
          scp -o StrictHostKeyChecking=no postgres@$SELECTED_DB_SERVER:/var/lib/pgsql/data/service_templates/lb_web/yaml/deployment.yaml /tmp/lb-web/deployment.yaml

          echo "ğŸš€ Copying deployment script and YAML to Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "mkdir -p /tmp/lb-web"
          scp -o StrictHostKeyChecking=no /tmp/lb-web/deploy.sh devops@192.168.30.32:/tmp/lb-web/deploy.sh
          scp -o StrictHostKeyChecking=no /tmp/lb-web/deployment.yaml devops@192.168.30.32:/tmp/lb-web/deployment.yaml

      - name: Execute Deploy Script on Kubernetes Master Server
        run: |
          echo "ğŸš€ Executing deployment script on Kubernetes master server (192.168.30.32)..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "chmod +x /tmp/lb-web/deploy.sh && /tmp/lb-web/deploy.sh"
