name: Deploy lb-web on External K8s Server (Local with SSH)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ðŸ”§ Install PostgreSQL Client on CentOS
        run: |
          echo "ðŸ”§ Checking if PostgreSQL Client (psql) is installed..."
          if ! command -v psql &> /dev/null
          then
            echo "âš ï¸ PostgreSQL Client not found. Installing..."
            sudo yum install -y postgresql
          else
            echo "âœ… PostgreSQL Client is already installed."
          fi

      - name: ðŸ”‘ Setup PostgreSQL Authentication (Avoid Password Prompts)
        run: |
          echo "ðŸ”§ Configuring PostgreSQL authentication..."
          echo "192.168.60.67:5001:*:postgres:qaz123" > ~/.pgpass
          echo "192.168.60.67:5000:*:postgres:qaz123" >> ~/.pgpass
          chmod 600 ~/.pgpass

      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ“‚ Copy lb-web files from DB Server (192.168.60.64) to Master Server
        run: |
          echo "ðŸ“¥ Copying lb-web files from DB Server (192.168.60.64) to Master Server..."
          
          ssh -o StrictHostKeyChecking=no devops@192.168.60.64 "sudo mkdir -p /tmp/lb-web && sudo cp -r /var/lib/pgsql/data/service_templates/lb_web/scripts /tmp/lb-web/ && sudo cp -r /var/lib/pgsql/data/service_templates/lb_web/yaml /tmp/lb-web/ && sudo chmod -R 755 /tmp/lb-web"

          echo "ðŸš€ Copying lb-web deploy script and YAMLs to Kubernetes
