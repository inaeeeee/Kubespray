name: Monitor Kubernetes Cluster (monitoring)

on:
  workflow_dispatch:

jobs:
  monitor:
    runs-on: self-hosted

    steps:
      - name: üîß Install PostgreSQL Client on CentOS
        run: |
          echo "üîß Checking if PostgreSQL Client (psql) is installed..."
          if ! command -v psql &> /dev/null
          then
            echo "‚ö†Ô∏è PostgreSQL Client not found. Installing..."
            sudo yum install -y postgresql
          else
            echo "‚úÖ PostgreSQL Client is already installed."
          fi

      - name: üîë Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan 192.168.60.67 >> ~/.ssh/known_hosts
          ssh-keyscan 192.168.30.32 >> ~/.ssh/known_hosts

      - name: üßæ Setup PostgreSQL Authentication
        run: |
          echo "üîß Configuring PostgreSQL authentication..."
          echo "192.168.60.67:5001:*:postgres:qaz123" > ~/.pgpass  # Slave
          echo "192.168.60.67:5000:*:postgres:qaz123" >> ~/.pgpass  # Master
          chmod 600 ~/.pgpass

      - name: üì¶ Checkout Repository
        uses: actions/checkout@v3

      - name: üîç Fetch Monitoring Deployment Info from DB
        run: |
          echo "üîç Fetching monitoring deployment script from DB..."

          SERVICE_INFO=$(psql -h 192.168.60.67 -p 5001 -U postgres -d solmakasedb -t -w -c \
            "SELECT name, deploy_script FROM ServiceTemplate WHERE name = 'monitoring';")

          if [[ -z "$SERVICE_INFO" ]]; then
            echo "‚ùå No deployment information found for monitoring!"
            exit 1
          fi

          echo "‚úÖ Found monitoring service info: $SERVICE_INFO"
          DEPLOY_SCRIPT=$(echo "$SERVICE_INFO" | awk -F '|' '{print $2}' | xargs)
          echo "üìå Deploy Script Path: $DEPLOY_SCRIPT"

      - name: üì• Copy Monitoring Files from PostgreSQL Server to Runner
        run: |
          echo "üì• Copying monitoring deploy script and YAML files from PostgreSQL server..."
          mkdir -p /tmp/monitoring/yaml

          scp -o StrictHostKeyChecking=no postgres@192.168.60.67:/var/lib/pgsql/data/service_templates/monitoring/scripts/deploy.sh /tmp/monitoring/deploy.sh
          scp -o StrictHostKeyChecking=no postgres@192.168.60.67:/var/lib/pgsql/data/service_templates/monitoring/yaml/*.yaml /tmp/monitoring/yaml/

      - name: üîß Prepare Monitoring Folder on Kubernetes Master
        run: |
          echo "üîß Preparing /tmp/monitoring on Kubernetes master server..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "sudo mkdir -p /tmp/monitoring && sudo chown -R devops:devops /tmp/monitoring"

      - name: üöÄ Copy Monitoring Files to Kubernetes Master
        run: |
          echo "üöÄ Copying monitoring files to Kubernetes master server..."
          scp -o StrictHostKeyChecking=no /tmp/monitoring/deploy.sh devops@192.168.30.32:/tmp/monitoring/deploy.sh
          scp -o StrictHostKeyChecking=no /tmp/monitoring/yaml/*.yaml devops@192.168.30.32:/tmp/monitoring/yaml/

      - name: üõ† Execute Monitoring Deploy Script on Master
        run: |
          echo "üöÄ Executing monitoring deploy script on Kubernetes master server..."
          ssh -o StrictHostKeyChecking=no devops@192.168.30.32 "chmod +x /tmp/monitoring/deploy.sh && /tmp/monitoring/deploy.sh"

      - name: üóÑ Store Monitoring Pod Info in PostgreSQL (Master)
        run: |
          echo "üóÑ Fetching monitoring pod info and storing in DB..."

          POD_INFO=$(ssh -o StrictHostKeyChecking=no devops@192.168.30.32 \
            "kubectl get pods -n monitoring -o jsonpath='{range .items[*]}{.metadata.name}{\"|\"}{.status.podIP}{\"\n\"}{end}'" | tr -d '\r')

          if [[ -z "$POD_INFO" ]]; then
              echo "‚ùå ERROR: No monitoring pods found!"
              exit 1
          fi

          echo "‚úÖ Monitoring Pod Info Retrieved: $POD_INFO"

          TEMPLATE_ID=$(psql -h 192.168.60.67 -p 5001 -U postgres -d solmakasedb -t -w -c \
            "SELECT id FROM ServiceTemplate WHERE name = 'monitoring';" | xargs)

          if [[ -z "$TEMPLATE_ID" ]]; then
              echo "‚ùå ERROR: No matching ServiceTemplate found for 'monitoring'!"
              exit 1
          fi

          echo "üìå Found Template ID: $TEMPLATE_ID"

          while IFS="|" read -r HOSTNAME IP_ADDRESS; do
              if [[ -n "$HOSTNAME" && -n "$IP_ADDRESS" ]]; then
                  echo "üìå Storing VM: $HOSTNAME ($IP_ADDRESS) in PostgreSQL"

                  psql -h 192.168.60.67 -p 5000 -U postgres -d solmakasedb -c \
                  "INSERT INTO VM (template_id, hostname, ip_address, status, deploy_method)
                   VALUES ($TEMPLATE_ID, '$HOSTNAME', '$IP_ADDRESS', 'running', 'monitoring')
                   ON CONFLICT (hostname) 
                   DO UPDATE SET ip_address = EXCLUDED.ip_address, status = 'running';"
              fi
          done <<< "$POD_INFO"

          echo "‚úÖ Monitoring VM Info Successfully Stored in PostgreSQL"
